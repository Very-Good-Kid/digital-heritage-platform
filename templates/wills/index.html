{% extends "base.html" %}

{% block title %}数字资产继承意愿声明书 - 故里{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-file-text"></i> 数字资产继承意愿声明书</h2>
            <p class="text-muted">创建您的数字资产继承意愿声明书，表达对数字资产的处置意愿</p>
        </div>
    </div>

    <div class="row">
        <!-- 创建声明书表单 -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-file-plus"></i> 创建数字资产继承意愿声明书</h5>
                    <div>
                        <a href="{{ url_for('static', filename='templates/数字遗产意愿声明模板.pdf') }}" class="btn btn-outline-primary btn-sm me-2" download>
                            <i class="bi bi-file-earmark-pdf"></i> 下载PDF模板
                        </a>
                        <span class="badge bg-secondary">结构化表单</span>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('wills') }}" id="willForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <!-- 模块一：声明人基础信息栏（必填） -->
                        <div class="mb-4 p-3 bg-light border rounded">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-person-badge me-2"></i>声明人基础信息栏
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="declarant_name" class="form-label">声明人姓名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="declarant_name" name="declarant_name" required
                                           placeholder="请输入姓名">
                                </div>
                                <div class="col-md-4">
                                    <label for="declarant_id" class="form-label">身份证号 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="declarant_id" name="declarant_id" required
                                           placeholder="请输入身份证号" maxlength="18">
                                </div>
                                <div class="col-md-4">
                                    <label for="declarant_nation" class="form-label">民族 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="declarant_nation" name="declarant_nation" required
                                           placeholder="如：汉族">
                                </div>
                            </div>
                        </div>

                        <!-- 核心生效前提 -->
                        <div class="mb-4">
                            <div class="alert alert-info mb-0">
                                <p class="mb-0">
                                    <strong>核心生效前提：</strong>本声明书在声明人身故或丧失自主行为能力后生效，指定联系人按本声明处置数字资产。法律依据：《中华人民共和国民法典》及对应平台用户协议。
                                </p>
                            </div>
                        </div>

                        <!-- 模块二：数字资产类型与处置意愿 -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-wallet2 me-2"></i>数字资产类型与处置意愿
                            </h6>
                            <small class="text-muted d-block mb-3">请为每类资产勾选处置意愿</small>

                            <!-- 社交媒体类 -->
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <strong>一、社交媒体（微信、QQ等）</strong>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label"><strong>处置意愿：</strong></label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="social_action" value="设为纪念账户" id="social_memorial">
                                                    <label class="form-check-label" for="social_memorial">设为纪念账户</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="social_action" value="注销账户" id="social_cancel">
                                                    <label class="form-check-label" for="social_cancel">注销账户</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="social_action" value="移交内容给继承人" id="social_transfer">
                                                    <label class="form-check-label" for="social_transfer">移交内容给继承人</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="social_action" value="其他" id="social_other">
                                                    <label class="form-check-label" for="social_other">其他（自定义填写）：</label>
                                                    <input type="text" class="form-control form-control-sm mt-1" name="social_other_text" placeholder="请说明">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 电子邮箱与云存储类 -->
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <strong>二、电子邮箱与云存储（iCloud、网盘等）</strong>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label"><strong>处置意愿：</strong></label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="cloud_action" value="允许继承人访问" id="cloud_access">
                                                    <label class="form-check-label" for="cloud_access">允许继承人访问</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="cloud_action" value="永久删除/关闭" id="cloud_delete">
                                                    <label class="form-check-label" for="cloud_delete">永久删除/关闭</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="cloud_action" value="其他" id="cloud_other">
                                                    <label class="form-check-label" for="cloud_other">其他（自定义填写）：</label>
                                                    <input type="text" class="form-control form-control-sm mt-1" name="cloud_other_text" placeholder="请说明">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 数字货币与金融App类 -->
                            <div class="card mb-3">
                                <div class="card-header bg-warning">
                                    <strong>三、数字货币与金融App（比特币、游戏账号等）</strong>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label"><strong>处置意愿：</strong></label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="finance_action" value="移交私钥/密码" id="finance_key">
                                                    <label class="form-check-label" for="finance_key">移交私钥/密码</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="finance_action" value="兑换为法币后继承" id="finance_convert">
                                                    <label class="form-check-label" for="finance_convert">兑换为法币后继承</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="finance_action" value="其他" id="finance_other">
                                                    <label class="form-check-label" for="finance_other">其他（自定义填写）：</label>
                                                    <input type="text" class="form-control form-control-sm mt-1" name="finance_other_text" placeholder="请说明">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 模块三：指定执行人/联系人信息模块 -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-person-lines-fill me-2"></i>指定执行人/联系人信息模块
                            </h6>

                            <!-- 主要联系人 -->
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <strong>主要联系人（必填）</strong>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small mb-3">该联系人将全权负责启动并主导本声明所涉的资产处置流程</p>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="primary_name" class="form-label">姓名 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="primary_name" name="primary_name" required
                                                   placeholder="联系人姓名">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="primary_relation" class="form-label">与声明人关系 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="primary_relation" name="primary_relation" required
                                                   placeholder="如：配偶、子女、父母">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="primary_phone" class="form-label">联系电话 <span class="text-danger">*</span></label>
                                            <input type="tel" class="form-control" id="primary_phone" name="primary_phone" required
                                                   placeholder="手机号码">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 备用联系人 -->
                            <div class="card mb-3">
                                <div class="card-header bg-secondary text-white">
                                    <strong>备用联系人（必填）</strong>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small mb-3">仅当主要联系人无法履行职责时，备用联系人方可接替其职责</p>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="backup_name" class="form-label">姓名 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="backup_name" name="backup_name" required
                                                   placeholder="联系人姓名">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="backup_relation" class="form-label">与声明人关系 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="backup_relation" name="backup_relation" required
                                                   placeholder="如：配偶、子女、父母">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="backup_phone" class="form-label">联系电话 <span class="text-danger">*</span></label>
                                            <input type="tel" class="form-control" id="backup_phone" name="backup_phone" required
                                                   placeholder="手机号码">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 模块底部固定文案 -->
                            <div class="alert alert-secondary mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>此指定仅为操作授权，并不涉及或改变任何法定继承人之实质财产继承权</strong>
                            </div>
                        </div>

                        <!-- 模块四：法律效力说明模块 -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-file-earmark-text me-2"></i>法律效力说明
                            </h6>

                            <!-- 固定法律效力声明 -->
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="text-primary mb-3"><i class="bi bi-shield-check me-2"></i>法律效力声明（固定文案）</h6>
                                    <p class="mb-0" style="line-height: 1.8;">
                                        本人确认，本声明书旨在清晰表达本人关于数字资产处置的最终意愿，并为继承人提供明确指引。本人理解，本声明书本身并非具有直接强制执行力的法律文件，数字资产的最终归属与处理须遵守《中华人民共和国民法典》等法律规定及各平台合约。本人建议，可将本声明书进行公证，或作为本人正式遗嘱之附件，以增强其法律参考效力。
                                    </p>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="assets_data" id="assets_data" value="{}">

                        <div class="alert alert-secondary">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>提示：</strong>声明人签名和日期将在预览及PDF中留空，需手写签署。
                            </small>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-file-plus"></i> 创建声明书
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 声明书列表 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-list-ul"></i> 我的声明书</h5>
                    <span class="badge bg-success">{{ wills|length }} 份</span>
                </div>
                <div class="card-body">
                    {% if wills %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>标题</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for will in wills %}
                                <tr data-will-id="{{ will.id }}" data-current-status="{{ will.status }}">
                                    <td><small>{{ will.title }}</small></td>
                                    <td>
                                        <span class="badge bg-{% if will.status == 'draft' %}secondary{% elif will.status == 'confirmed' %}success{% else %}dark{% endif %} status-badge">
                                            {% if will.status == 'draft' %}草稿{% elif will.status == 'confirmed' %}已确认{% else %}已归档{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('view_will', will_id=will.id) }}" class="btn btn-outline-primary" title="查看">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{{ url_for('generate_pdf', will_id=will.id) }}" class="btn btn-outline-success" title="下载PDF">
                                                <i class="bi bi-file-earmark-pdf"></i>
                                            </a>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" title="修改状态">
                                                    <i class="bi bi-three-dots"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <a class="dropdown-item status-change-item" href="#" data-status="draft" data-will-id="{{ will.id }}">
                                                            <i class="bi bi-pencil-square me-2"></i>草稿
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item status-change-item" href="#" data-status="confirmed" data-will-id="{{ will.id }}">
                                                            <i class="bi bi-check-circle me-2"></i>已确认
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item status-change-item" href="#" data-status="archived" data-will-id="{{ will.id }}">
                                                            <i class="bi bi-archive me-2"></i>已归档
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                            <form method="POST" action="{{ url_for('delete_will', will_id=will.id) }}" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-outline-danger" title="删除" onclick="return confirm('确定要删除这份声明书吗？')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark fs-1 text-muted"></i>
                        <h6 class="text-muted mt-3">暂无声明书</h6>
                        <p class="text-muted small">创建您的第一份数字资产继承意愿声明书</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 法律提示 -->
            <div class="alert alert-warning mt-3">
                <h6><i class="bi bi-exclamation-triangle"></i> 重要法律提示</h6>
                <p class="mb-0 small">
                    本文件可作为您意愿的强烈表达，协助继承人沟通，但不替代正式公证遗嘱。
                    建议在制定此声明后，咨询专业律师，并考虑进行公证。
                </p>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.getElementById('willForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // 收集资产数据
    const assetsData = {
        declarant_name: document.getElementById('declarant_name').value,
        declarant_id: document.getElementById('declarant_id').value,
        declarant_nation: document.getElementById('declarant_nation').value,
        primary_name: document.getElementById('primary_name').value,
        primary_relation: document.getElementById('primary_relation').value,
        primary_phone: document.getElementById('primary_phone').value,
        backup_name: document.getElementById('backup_name').value,
        backup_relation: document.getElementById('backup_relation').value,
        backup_phone: document.getElementById('backup_phone').value
    };

    // 社交媒体
    const socialActions = [];
    document.querySelectorAll('input[name="social_action"]:checked').forEach(cb => {
        if (cb.value === '其他') {
            const otherText = document.querySelector('input[name="social_other_text"]').value;
            socialActions.push(otherText ? `其他：${otherText}` : '其他');
        } else {
            socialActions.push(cb.value);
        }
    });
    if (socialActions.length > 0) {
        assetsData.social = {
            category: '社交媒体',
            actions: socialActions
        };
    }

    // 电子邮箱与云存储
    const cloudActions = [];
    document.querySelectorAll('input[name="cloud_action"]:checked').forEach(cb => {
        if (cb.value === '其他') {
            const otherText = document.querySelector('input[name="cloud_other_text"]').value;
            cloudActions.push(otherText ? `其他：${otherText}` : '其他');
        } else {
            cloudActions.push(cb.value);
        }
    });
    if (cloudActions.length > 0) {
        assetsData.cloud = {
            category: '电子邮箱与云存储',
            actions: cloudActions
        };
    }

    // 数字货币与金融App
    const financeActions = [];
    document.querySelectorAll('input[name="finance_action"]:checked').forEach(cb => {
        if (cb.value === '其他') {
            const otherText = document.querySelector('input[name="finance_other_text"]').value;
            financeActions.push(otherText ? `其他：${otherText}` : '其他');
        } else {
            financeActions.push(cb.value);
        }
    });
    if (financeActions.length > 0) {
        assetsData.finance = {
            category: '数字货币与金融App',
            actions: financeActions
        };
    }

    document.getElementById('assets_data').value = JSON.stringify(assetsData);
    this.submit();
});

// 状态修改功能
document.querySelectorAll('.status-change-item').forEach(item => {
    item.addEventListener('click', async function(e) {
        e.preventDefault();

        const willId = this.getAttribute('data-will-id');
        const newStatus = this.getAttribute('data-status');
        const statusLabels = {
            'draft': '草稿',
            'confirmed': '已确认',
            'archived': '已归档'
        };

        try {
            const url = `/wills/${willId}/status`;
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

            const headers = {
                'Content-Type': 'application/json'
            };

            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ status: newStatus })
            });

            const result = await response.json();

            if (result.success) {
                const row = document.querySelector(`tr[data-will-id="${willId}"]`);
                const badge = row.querySelector('.status-badge');

                badge.classList.remove('bg-secondary', 'bg-success', 'bg-dark');

                if (newStatus === 'draft') {
                    badge.classList.add('bg-secondary');
                } else if (newStatus === 'confirmed') {
                    badge.classList.add('bg-success');
                } else {
                    badge.classList.add('bg-dark');
                }

                badge.textContent = statusLabels[newStatus];
                row.setAttribute('data-current-status', newStatus);

                row.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            } else {
                alert(result.message || '状态更新失败');
            }
        } catch (error) {
            console.error('状态更新错误:', error);
            alert('状态更新失败，请重试');
        }
    });
});
</script>
{% endblock %}
{% endblock %}
